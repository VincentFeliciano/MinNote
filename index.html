<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Minimal Notes â€“ Fixed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #ffffff;
            --bg-secondary: #fbfbfc;
            --bg-hover: #FFDD44;
            --bg-active: #FFDD44;
            --border: #e5e5e7;
            --text: #1c1c1e;
            --text-muted: #8e8e93;
            --input-bg: #f9f9fa;
            --input-Nbg: #FFDD44;
            --delete-red: #ff3b30;
            --delete-dark: #ff453a;
            --modal-overlay: rgba(0, 0, 0, 0.4);
            --panel-width: 280px;
        }

        body.dark {
            --bg: #1c1c1e;
            --bg-secondary: #2c2c2e;
            --bg-hover: #101585;
            --bg-active: #101585;
            --border: #3a3a3c;
            --text: #f2f2f7;
            --text-muted: #a1a1a6;
            --input-bg: #2c2c2e;
            --input-Nbg: #101585;
            --delete-red: #ff453a;
            --modal-overlay: rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            touch-action: none;
        }

        .app {
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .topbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 100;
            background: var(--bg);
        }

        .logo-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 28px;
            flex-shrink: 0;
        }

        .logo-btn svg {
            width: 35px;
            height: 19px;
        }

        .search {
            flex: 1;
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            margin-left: 0;
        }

        .btn {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            cursor: pointer;
            flex-shrink: 0;
        }

        .NNbtn {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--input-Nbg);
            color: var(--text);
            cursor: pointer;
            flex-shrink: 0;
        }

        .main {
            display: flex;
            flex: 1;
            min-height: 0;
            position: relative;
            overflow: hidden;
        }

        /* Side panel for mobile */
        .side-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--panel-width);
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            z-index: 90;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
            touch-action: pan-y;
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .side-panel-header {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            flex-shrink: 0;
            touch-action: none;
        }

        .side-panel-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .close-panel-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-panel-btn:hover {
            background: var(--bg-hover);
        }

        .note-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        /* Search preview panel */
        .search-preview-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--panel-width);
            height: 100vh;
            background: var(--bg);
            border-right: 1px solid var(--border);
            z-index: 95;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
            touch-action: pan-y;
        }

        .search-preview-panel.open {
            transform: translateX(0);
        }

        .search-preview-header {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            flex-shrink: 0;
            touch-action: none;
        }

        .search-preview-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .close-search-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .close-search-btn:hover {
            background: var(--bg-hover);
        }

        .search-results-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
        }

        /* Edge pull handle */
        .edge-pull-handle {
            position: fixed;
            top: 0;
            left: 0;
            width: 20px;
            height: 100vh;
            z-index: 80;
            cursor: grab;
            display: none;
            touch-action: none;
        }

        .edge-pull-handle.active {
            cursor: grabbing;
        }

        .edge-pull-indicator {
            position: absolute;
            top: 50%;
            left: 4px;
            transform: translateY(-50%);
            width: 4px;
            height: 40px;
            background: var(--text-muted);
            border-radius: 2px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .edge-pull-handle:hover .edge-pull-indicator {
            opacity: 1;
        }

        /* Panel overlay */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 85;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(2px);
            touch-action: none;
        }

        .panel-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Desktop list - REMOVED THE HEADER */
        .desktop-list {
            width: 28%;
            border-right: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* Remove desktop list header */
        .desktop-list-header {
            display: none;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .editor {
            flex: 1;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #editor {
            flex: 1;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text);
            font-family: inherit;
            min-height: 0;
            cursor: text;
            -webkit-user-select: text;
            user-select: text;
        }

        #editor>div:first-child {
            font-size: 20px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        #editor:empty:before {
            content: attr(data-placeholder);
            color: var(--text-muted);
        }

        .hint {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 6px;
            flex-shrink: 0;
            padding: 0 20px 16px;
        }

        /* Note styles */
        .note {
            position: relative;
            border-radius: 6px;
            margin-bottom: 4px;
            overflow: hidden;
            background: transparent;
        }

        .note .swipe-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--delete-red);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: #fff;
            font-weight: bold;
            z-index: 0;
            border-radius: 0;
            transform: translateX(100%);
            transition: transform 0.2s ease-out;
        }

        .note.swiping .swipe-bg {
            transform: translateX(0);
        }

        .note-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 10px 12px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            transition: background .2s, transform .2s;
            transform: translateX(0);
            overflow: hidden;
        }

        .note.active .note-content {
            background: var(--bg-active);
            font-weight: 500;
        }

        .note:hover .note-content {
            background: var(--bg-hover);
        }

        .note mark {
            background: #ffd600;
            color: inherit;
        }

        body.dark .note mark {
            background: #ffd60a;
            color: #000;
        }

        .delete-btn {
            opacity: 0;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-muted);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .delete-btn svg {
            display: block;
            stroke: currentColor;
        }

        .note:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            color: var(--text);
        }

        .empty-state {
            text-align: center;
            padding: 24px 12px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* Desktop: show all notes, scroll when needed */
        @media (min-width: 769px) {
            body {
                position: static;
                overflow: auto;
            }
            
            .app {
                height: auto;
                min-height: 100vh;
            }
            
            .desktop-list {
                height: auto;
                overflow-y: hidden;
            }
            
            .note-list-container {
                overflow-y: auto;
            }
            
            /* Hide mobile elements on desktop */
            .side-panel,
            .search-preview-panel,
            .edge-pull-handle,
            .panel-overlay {
                display: none !important;
            }
        }

        /* Mobile: slide-out panel from left */
        @media (max-width: 768px) {
            body {
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }
            
            .app {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                max-width: 100%;
                margin: 0;
                height: 100%;
                overflow: hidden;
            }

            .main {
                flex-direction: column;
                height: calc(100% - 49px);
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }

            /* Hide desktop list on mobile */
            .desktop-list {
                display: none;
            }

            /* Show edge pull handle */
            .edge-pull-handle {
                display: block;
            }

            .editor-container {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                position: relative;
                width: 100%;
            }

            .editor {
                padding: 12px 16px;
                flex: 1;
                overflow-y: auto;
                min-height: 0;
                height: 100%;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 20px;
            }

            .hint {
                padding: 0 16px 12px;
                flex-shrink: 0;
            }

            /* When virtual keyboard is active */
            .keyboard-active .editor {
                padding-top: 8px;
                padding-bottom: 40px;
            }

            .keyboard-active .hint {
                display: none;
            }
            
            /* Adjust for iOS Safari bottom bar */
            @supports (-webkit-touch-callout: none) {
                body {
                    height: -webkit-fill-available;
                }
                
                .app {
                    height: -webkit-fill-available;
                }
                
                .editor {
                    padding-bottom: env(safe-area-inset-bottom, 20px);
                }
                
                .side-panel,
                .search-preview-panel {
                    padding-top: env(safe-area-inset-top, 0);
                    height: calc(100vh - env(safe-area-inset-top, 0));
                }
            }
        }

        /* Delete Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-overlay);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
            min-width: 300px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        .modal-message {
            font-size: 15px;
            color: var(--text-muted);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 80px;
        }

        .modal-btn.cancel:hover {
            background: var(--bg-hover);
        }

        .modal-btn.delete {
            background: var(--delete-red);
            color: white;
            border-color: var(--delete-red);
        }

        .modal-btn.delete:hover {
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="topbar">
            <button class="logo-btn" id="logoBtn">
                <svg width="35" height="19" viewBox="0 0 35 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M4.09943 0.997175L8.31818 14.2585H8.48011L12.7074 0.997175H16.7983L10.7813 18.4517H6.02557L7.30157e-07 0.997175H4.09943ZM17.151 18.4517V5.36081H20.7816V18.4517H17.151ZM18.9748 3.67331C18.4351 3.67331 17.972 3.49433 17.5856 3.13638C17.2049 2.77274 17.0146 2.33808 17.0146 1.8324C17.0146 1.3324 17.2049 0.903425 17.5856 0.545471C17.972 0.181834 18.4351 1.57356e-05 18.9748 1.57356e-05C19.5146 1.57356e-05 19.9748 0.181834 20.3555 0.545471C20.7419 0.903425 20.9351 1.3324 20.9351 1.8324C20.9351 2.33808 20.7419 2.77274 20.3555 3.13638C19.9748 3.49433 19.5146 3.67331 18.9748 3.67331ZM25.6407 10.8835V18.4517H22.01V5.36081H25.4703V7.67047H25.6237C25.9134 6.90911 26.3992 6.30683 27.0811 5.86365C27.7629 5.41479 28.5896 5.19036 29.5612 5.19036C30.4703 5.19036 31.2629 5.38922 31.939 5.78695C32.6151 6.18468 33.1407 6.75286 33.5157 7.49149C33.8907 8.22445 34.0782 9.09945 34.0782 10.1165V18.4517H30.4475V10.7642C30.4532 9.96308 30.2487 9.33808 29.8339 8.88922C29.4191 8.43468 28.8481 8.2074 28.1208 8.2074C27.6322 8.2074 27.2004 8.31252 26.8254 8.52274C26.4561 8.73297 26.1663 9.03979 25.9561 9.4432C25.7515 9.84093 25.6464 10.321 25.6407 10.8835Z"
                        fill="black" />
                </svg>
            </button>

            <input class="search" placeholder="Searchâ€¦" />
            <button class="btn" id="toggleTheme">ðŸŒ™</button>
            <button class="NNbtn" id="newNote">ï¼‹</button>
        </div>
        
        <!-- Edge pull handle for mobile -->
        <div class="edge-pull-handle" id="edgePullHandle">
            <div class="edge-pull-indicator"></div>
        </div>
        
        <!-- Panel overlay -->
        <div class="panel-overlay" id="panelOverlay"></div>
        
        <!-- Mobile side panel (for notes list) -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-header">
                <div class="side-panel-title">Notes</div>
                <button class="close-panel-btn" id="closePanelBtn">Ã—</button>
            </div>
            <div class="note-list-container" id="noteListContainer">
                <!-- Notes will be rendered here -->
            </div>
        </div>
        
        <!-- Search preview panel -->
        <div class="search-preview-panel" id="searchPreviewPanel">
            <div class="search-preview-header">
                <div class="search-preview-title">Search Results</div>
                <button class="close-search-btn" id="closeSearchBtn">Ã—</button>
            </div>
            <div class="search-results-container" id="searchResultsContainer">
                <!-- Search results will be rendered here -->
            </div>
        </div>
        
        <div class="main">
            <!-- Desktop list - NO HEADER -->
            <div class="desktop-list" id="desktopList">
                <div class="note-list-container" id="desktopNoteListContainer">
                    <!-- Desktop notes will be rendered here -->
                </div>
            </div>
            
            <div class="editor-container">
                <div class="editor">
                    <div id="editor" contenteditable="true" spellcheck="false" data-placeholder="Start typingâ€¦"></div>
                </div>
                <div class="hint">Everything saves automatically</div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title">Delete Note</div>
            <div class="modal-message">Are you sure you want to delete this note? This action cannot be undone.</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                <button class="modal-btn delete" id="modalDelete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        /* ---------- helpers ---------- */
        const $ = q => document.querySelector(q);
        const escapeHTML = t => {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        };

        /* ---------- state ---------- */
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let activeId = localStorage.getItem('activeId');
        let theme = localStorage.getItem('theme') || 'light';
        let searchTimeout = null;
        let noteToDelete = null;
        let isMobile = window.innerWidth <= 768;
        let keyboardActive = false;
        let windowHeight = window.innerHeight;
        let currentPanel = null; // 'notes', 'search', or null
        let swipeData = {
            startX: 0,
            currentX: 0,
            panelElement: null,
            panelType: null,
            isSwiping: false,
            startTransform: 0
        };
        const SWIPE_THRESHOLD = 50;
        const PANEL_WIDTH = 280;
        const CLOSE_THRESHOLD = 0.3; // Close if swiped less than 30% of panel width

        /* ---------- update logo based on theme ---------- */
        function updateLogo() {
            const logoBtn = $('#logoBtn');
            if (theme === 'dark') {
                logoBtn.innerHTML = `
      <svg width="35" height="19" viewBox="0 0 35 19" fill="none" xmlns="http://www.w3.org2000/svg">
        <path d="M4.09943 0.99716L8.31818 14.2585H8.48011L12.7074 0.99716H16.7983L10.7813 18.4517H6.02557L7.30157e-07 0.99716H4.09943ZM17.151 18.4517V5.3608H20.7816V18.4517H17.151ZM18.9748 3.6733C18.4351 3.6733 17.972 3.49432 17.5856 3.13636C17.2049 2.77273 17.0146 2.33807 17.0146 1.83239C17.0146 1.33239 17.2049 0.90341 17.5856 0.545456C17.972 0.181819 18.4351 4.76837e-07 18.9748 4.76837e-07C19.5146 4.76837e-07 19.9748 0.181819 20.3555 0.545456C20.7419 0.90341 20.9351 1.33239 20.9351 1.83239C20.9351 2.33807 20.7419 2.77273 20.3555 3.13636C19.9748 3.49432 19.5146 3.6733 18.9748 3.6733ZM25.6407 10.8835V18.4517H22.01V5.3608H25.4703V7.67046H25.6237C25.9134 6.90909 26.3992 6.30682 27.0811 5.86364C27.7629 5.41477 28.5896 5.19034 29.5612 5.19034C30.4703 5.19034 31.2629 5.38921 31.939 5.78693C32.6151 6.18466 33.1407 6.75284 33.5157 7.49148C33.8907 8.22443 34.0782 9.09943 34.0782 10.1165V18.4517H30.4475V10.7642C30.4532 9.96307 30.2487 9.33807 29.8339 8.88921C29.4191 8.43466 28.8481 8.20739 28.1208 8.20739C27.6322 8.20739 27.2004 8.3125 26.8254 8.52273C26.4561 8.73296 26.1663 9.03977 25.9561 9.44318C25.7515 9.84091 25.6464 10.321 25.6407 10.8835Z" fill="white"/>
      </svg>
    `;
            } else {
                logoBtn.innerHTML = `
      <svg width="35" height="19" viewBox="0 0 35 19" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.09943 0.997175L8.31818 14.2585H8.48011L12.7074 0.997175H16.7983L10.7813 18.4517H6.02557L7.30157e-07 0.997175H4.09943ZM17.151 18.4517V5.36081H20.7816V18.4517H17.151ZM18.9748 3.67331C18.4351 3.67331 17.972 3.49433 17.5856 3.13638C17.2049 2.77274 17.0146 2.33808 17.0146 1.8324C17.0146 1.3324 17.2049 0.903425 17.5856 0.545471C17.972 0.181834 18.4351 1.57356e-05 18.9748 1.57356e-05C19.5146 1.57356e-05 19.9748 0.181834 20.3555 0.545471C20.7419 0.903425 20.9351 1.3324 20.9351 1.8324C20.9351 2.33808 20.7419 2.77274 20.3555 3.13638C19.9748 3.49433 19.5146 3.67331 18.9748 3.67331ZM25.6407 10.8835V18.4517H22.01V5.36081H25.4703V7.67047H25.6237C25.9134 6.90911 26.3992 6.30683 27.0811 5.86365C27.7629 5.41479 28.5896 5.19036 29.5612 5.19036C30.4703 5.19036 31.2629 5.38922 31.939 5.78695C32.6151 6.18468 33.1407 6.75286 33.5157 7.49149C33.8907 8.22445 34.0782 9.09945 34.0782 10.1165V18.4517H30.4475V10.7642C30.4532 9.96308 30.2487 9.33808 29.8339 8.88922C29.4191 8.43468 28.8481 8.2074 28.1208 8.2074C27.6322 8.2074 27.2004 8.31252 26.8254 8.52274C26.4561 8.73297 26.1663 9.03979 25.9561 9.4432C25.7515 9.84093 25.6464 10.321 25.6407 10.8835Z" fill="black"/>
      </svg>
    `;
            }
        }

        /* ---------- panel functions ---------- */
        function openPanel(type) {
            if (!isMobile) return;
            
            // Close any existing panel first
            if (currentPanel) {
                closePanel();
            }
            
            currentPanel = type;
            
            if (type === 'notes') {
                $('#sidePanel').classList.add('open');
            } else if (type === 'search') {
                $('#searchPreviewPanel').classList.add('open');
            }
            
            $('#panelOverlay').classList.add('visible');
            document.body.style.overflow = 'hidden';
        }

        function closePanel() {
            if (!isMobile || !currentPanel) return;
            
            if (currentPanel === 'notes') {
                $('#sidePanel').classList.remove('open');
            } else if (currentPanel === 'search') {
                $('#searchPreviewPanel').classList.remove('open');
            }
            
            currentPanel = null;
            $('#panelOverlay').classList.remove('visible');
            document.body.style.overflow = '';
        }

        function closeAllPanels() {
            closePanel();
        }

        function togglePanel() {
            if (currentPanel === 'notes') {
                closePanel();
            } else {
                openPanel('notes');
            }
        }

        /* ---------- swipe functions ---------- */
        function startSwipe(e, panelElement, panelType) {
            if (!isMobile) return;
            
            swipeData = {
                startX: e.touches[0].clientX,
                currentX: e.touches[0].clientX,
                panelElement: panelElement,
                panelType: panelType,
                isSwiping: true,
                startTransform: currentPanel === panelType ? 0 : -100
            };
            
            // Disable transitions during swipe
            panelElement.style.transition = 'none';
            
            // If panel is open, we're swiping to close
            // If panel is closed, we're swiping to open from edge
            if (currentPanel === panelType) {
                // Swipe to close - panel is currently open
                panelElement.style.transform = 'translateX(0)';
            } else {
                // Swipe to open - panel is currently closed
                panelElement.style.transform = 'translateX(-100%)';
            }
        }

        function updateSwipe(e) {
            if (!swipeData.isSwiping) return;
            
            swipeData.currentX = e.touches[0].clientX;
            const deltaX = swipeData.currentX - swipeData.startX;
            
            // Calculate new position
            let newTransform;
            if (currentPanel === swipeData.panelType) {
                // Swiping to close: start at 0, move left (negative)
                newTransform = Math.min(0, Math.max(-100, (deltaX / PANEL_WIDTH) * 100));
            } else {
                // Swiping to open: start at -100, move right (positive)
                newTransform = Math.min(0, Math.max(-100, -100 + (deltaX / PANEL_WIDTH) * 100));
            }
            
            swipeData.panelElement.style.transform = `translateX(${newTransform}%)`;
        }

        function endSwipe() {
            if (!swipeData.isSwiping || !swipeData.panelElement) return;
            
            const deltaX = swipeData.currentX - swipeData.startX;
            const deltaPercent = Math.abs(deltaX / PANEL_WIDTH);
            
            // Re-enable transitions
            swipeData.panelElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            
            if (currentPanel === swipeData.panelType) {
                // Swiping to close
                if (deltaPercent > CLOSE_THRESHOLD && deltaX < 0) {
                    // Swiped enough to close
                    closePanel();
                } else {
                    // Not enough swipe, stay open
                    swipeData.panelElement.style.transform = 'translateX(0)';
                }
            } else {
                // Swiping to open
                if (deltaPercent > CLOSE_THRESHOLD && deltaX > 0) {
                    // Swiped enough to open
                    openPanel(swipeData.panelType);
                } else {
                    // Not enough swipe, stay closed
                    swipeData.panelElement.style.transform = 'translateX(-100%)';
                }
            }
            
            swipeData.isSwiping = false;
        }

        function setupSwipe() {
            if (!isMobile) return;
            
            const edgeHandle = $('#edgePullHandle');
            const sidePanel = $('#sidePanel');
            const searchPanel = $('#searchPreviewPanel');
            const panelOverlay = $('#panelOverlay');
            
            // Edge swipe to open
            edgeHandle.addEventListener('touchstart', (e) => {
                const searchValue = $('.search').value.trim();
                const panelToOpen = searchValue.length > 0 ? searchPanel : sidePanel;
                const panelType = searchValue.length > 0 ? 'search' : 'notes';
                
                startSwipe(e, panelToOpen, panelType);
                edgeHandle.classList.add('active');
                e.preventDefault();
            }, { passive: false });
            
            edgeHandle.addEventListener('touchmove', (e) => {
                updateSwipe(e);
                e.preventDefault();
            }, { passive: false });
            
            edgeHandle.addEventListener('touchend', () => {
                endSwipe();
                edgeHandle.classList.remove('active');
            });
            
            edgeHandle.addEventListener('touchcancel', () => {
                if (swipeData.isSwiping && swipeData.panelElement) {
                    swipeData.panelElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    swipeData.panelElement.style.transform = currentPanel === swipeData.panelType ? 'translateX(0)' : 'translateX(-100%)';
                }
                swipeData.isSwiping = false;
                edgeHandle.classList.remove('active');
            });
            
            // Swipe to close on open panels
            sidePanel.addEventListener('touchstart', (e) => {
                if (currentPanel === 'notes') {
                    startSwipe(e, sidePanel, 'notes');
                    e.preventDefault();
                }
            }, { passive: false });
            
            sidePanel.addEventListener('touchmove', (e) => {
                if (currentPanel === 'notes' && swipeData.isSwiping) {
                    updateSwipe(e);
                    e.preventDefault();
                }
            }, { passive: false });
            
            sidePanel.addEventListener('touchend', () => {
                if (currentPanel === 'notes' && swipeData.isSwiping) {
                    endSwipe();
                }
            });
            
            searchPanel.addEventListener('touchstart', (e) => {
                if (currentPanel === 'search') {
                    startSwipe(e, searchPanel, 'search');
                    e.preventDefault();
                }
            }, { passive: false });
            
            searchPanel.addEventListener('touchmove', (e) => {
                if (currentPanel === 'search' && swipeData.isSwiping) {
                    updateSwipe(e);
                    e.preventDefault();
                }
            }, { passive: false });
            
            searchPanel.addEventListener('touchend', () => {
                if (currentPanel === 'search' && swipeData.isSwiping) {
                    endSwipe();
                }
            });
            
            // Also allow swipe from very edge of screen
            document.addEventListener('touchstart', (e) => {
                if ((currentPanel) || e.touches[0].clientX > 30) return;
                
                const searchValue = $('.search').value.trim();
                const panelToOpen = searchValue.length > 0 ? searchPanel : sidePanel;
                const panelType = searchValue.length > 0 ? 'search' : 'notes';
                
                startSwipe(e, panelToOpen, panelType);
                edgeHandle.classList.add('active');
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                if (swipeData.isSwiping && !currentPanel) {
                    updateSwipe(e);
                }
            }, { passive: true });
            
            document.addEventListener('touchend', () => {
                if (swipeData.isSwiping && !currentPanel) {
                    endSwipe();
                    edgeHandle.classList.remove('active');
                }
            });
            
            // Cancel swipe on overlay
            panelOverlay.addEventListener('touchstart', () => {
                if (swipeData.isSwiping) {
                    swipeData.isSwiping = false;
                    if (swipeData.panelElement) {
                        swipeData.panelElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                        swipeData.panelElement.style.transform = currentPanel === swipeData.panelType ? 'translateX(0)' : 'translateX(-100%)';
                    }
                }
            });
        }

        /* ---------- theme ---------- */
        function applyTheme() {
            document.body.classList.toggle('dark', theme === 'dark');
            $('#toggleTheme').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ‘';
            localStorage.setItem('theme', theme);
            updateLogo();
        }
        $('#toggleTheme').onclick = () => { theme = theme === 'dark' ? 'light' : 'dark'; applyTheme(); };
        applyTheme();

        /* ---------- storage ---------- */
        function save() {
            localStorage.setItem('notes', JSON.stringify(notes));
            localStorage.setItem('activeId', activeId);
        }

        /* ---------- caret ---------- */
        function caretEnd(el) {
            el.focus();
            const r = document.createRange();
            r.selectNodeContents(el);
            r.collapse(false);
            const s = window.getSelection();
            s.removeAllRanges();
            s.addRange(r);
        }

        /* ---------- render ---------- */
        function render(filter = '') {
            const mobileContainer = $('#noteListContainer');
            const desktopContainer = $('#desktopNoteListContainer');
            const searchResultsContainer = $('#searchResultsContainer');
            
            const f = filter.toLowerCase();
            const filtered = notes.filter(n => !f || n.text.toLowerCase().includes(f));

            // Render notes list (all notes)
            const containers = isMobile ? [mobileContainer] : [desktopContainer];
            containers.forEach(container => {
                container.innerHTML = '';
                
                if (!notes.length) {
                    const e = document.createElement('div');
                    e.className = 'empty-state';
                    e.textContent = 'No notes yet';
                    container.appendChild(e);
                    return;
                }

                notes.forEach(n => {
                    const wrap = document.createElement('div');
                    wrap.className = 'note' + (n.id === activeId ? ' active' : '');
                    wrap.dataset.noteId = n.id;

                    const bg = document.createElement('div');
                    bg.className = 'swipe-bg';
                    bg.textContent = 'Delete';
                    wrap.appendChild(bg);

                    const content = document.createElement('div');
                    content.className = 'note-content';
                    let preview = (n.text.split('\n')[0] || 'Untitled').substring(0, 100);
                    preview = escapeHTML(preview);

                    const title = document.createElement('span');
                    title.innerHTML = preview;
                    title.style.cssText =
                        'flex:1;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';

                    const del = document.createElement('button');
                    del.className = 'delete-btn';
                    del.innerHTML = `
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                      </svg>
                    `;
                    del.setAttribute('aria-label', 'Delete note');
                    del.onclick = e => {
                        e.stopPropagation();
                        requestDeleteNote(n.id);
                    };

                    content.appendChild(title);
                    content.appendChild(del);
                    wrap.appendChild(content);

                    wrap.onclick = () => {
                        selectNote(n.id);
                        if (isMobile) {
                            closeAllPanels();
                        }
                    };
                    
                    addSwipe(wrap, n.id);
                    container.appendChild(wrap);
                });
            });

            // Render search results in separate panel
            if (searchResultsContainer) {
                searchResultsContainer.innerHTML = '';
                
                if (!filtered.length) {
                    const e = document.createElement('div');
                    e.className = 'empty-state';
                    e.textContent = f ? 'No notes match your search' : 'Type to search...';
                    searchResultsContainer.appendChild(e);
                    return;
                }

                filtered.forEach(n => {
                    const wrap = document.createElement('div');
                    wrap.className = 'note' + (n.id === activeId ? ' active' : '');
                    wrap.dataset.noteId = n.id;

                    const content = document.createElement('div');
                    content.className = 'note-content';
                    
                    // Create highlighted search preview
                    const idx = n.text.toLowerCase().indexOf(f);
                    let preview = '';
                    if (idx !== -1) {
                        const start = Math.max(0, idx - 20);
                        const end = Math.min(n.text.length, idx + f.length + 30);
                        let snippet = n.text.substring(start, end);
                        if (start > 0) snippet = 'â€¦' + snippet;
                        if (end < n.text.length) snippet += 'â€¦';
                        preview = escapeHTML(snippet).replace(
                            new RegExp(`(${escapeHTML(filter)})`, 'gi'),
                            '<mark>$1</mark>'
                        );
                    } else {
                        preview = escapeHTML((n.text.split('\n')[0] || 'Untitled').substring(0, 100));
                    }

                    const title = document.createElement('span');
                    title.innerHTML = preview;
                    title.style.cssText =
                        'flex:1;font-size:14px;line-height:1.4;white-space:normal;';

                    content.appendChild(title);
                    wrap.appendChild(content);

                    wrap.onclick = () => {
                        selectNote(n.id);
                        if (isMobile) {
                            closeAllPanels();
                            $('.search').value = '';
                        }
                    };
                    
                    searchResultsContainer.appendChild(wrap);
                });
            }
        }

        /* ---------- swipe ---------- */
        function addSwipe(el, id) {
            let sx = 0, cx = 0, swiping = false;
            const content = el.querySelector('.note-content');
            const swipeBg = el.querySelector('.swipe-bg');
            const threshold = 0.55;

            el.addEventListener('touchstart', e => {
                sx = e.touches[0].clientX;
                cx = sx;
                swiping = true;
                el.classList.add('swiping');
            }, { passive: true });

            el.addEventListener('touchmove', e => {
                if (!swiping) return;
                cx = e.touches[0].clientX;
                const dx = cx - sx;
                if (dx < 0) {
                    content.style.transform = `translateX(${dx}px)`;
                    swipeBg.style.transform = 'translateX(0)';
                }
            }, { passive: true });

            el.addEventListener('touchend', () => {
                swiping = false;
                el.classList.remove('swiping');
                const dx = cx - sx;
                const swipePercentage = -dx / el.offsetWidth;
                
                if (swipePercentage > threshold) {
                    deleteNote(id);
                } else {
                    content.style.transition = 'transform 0.3s ease-out';
                    swipeBg.style.transition = 'transform 0.3s ease-out';
                    content.style.transform = 'translateX(0)';
                    swipeBg.style.transform = 'translateX(100%)';
                    
                    setTimeout(() => {
                        content.style.transition = '';
                        swipeBg.style.transition = '';
                    }, 300);
                    
                    if (swipePercentage < 0.3) {
                        selectNote(id);
                        if (isMobile) {
                            closeAllPanels();
                        }
                    }
                }
            });

            el.addEventListener('touchcancel', () => {
                swiping = false;
                el.classList.remove('swiping');
                content.style.transition = 'transform 0.3s ease-out';
                swipeBg.style.transition = 'transform 0.3s ease-out';
                content.style.transform = 'translateX(0)';
                swipeBg.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    content.style.transition = '';
                    swipeBg.style.transition = '';
                }, 300);
            });
        }

        /* ---------- crud ---------- */
        function selectNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return createNote();
            activeId = id;
            $('#editor').innerHTML = note.text.split('\n').map(l => `<div>${escapeHTML(l) || '<br>'}</div>`).join('');
            render($('.search').value);
            save();
            setTimeout(() => {
                caretEnd($('#editor'));
            }, 0);
        }

        function createNote() {
            const note = { id: Date.now().toString(), text: '' };
            notes.unshift(note);
            activeId = note.id;
            $('#editor').innerHTML = '<div><br></div>';
            render($('.search').value);
            save();
            setTimeout(() => {
                caretEnd($('#editor'));
            }, 0);
            
            if (isMobile) {
                closeAllPanels();
            }
        }

        /* ---------- Delete with confirmation (desktop) ---------- */
        function requestDeleteNote(id) {
            if (window.innerWidth > 768) {
                noteToDelete = id;
                showModal();
            } else {
                deleteNote(id);
            }
        }

        function showModal() {
            const modalOverlay = $('#modalOverlay');
            modalOverlay.style.display = 'flex';
        }

        function hideModal() {
            const modalOverlay = $('#modalOverlay');
            modalOverlay.style.display = 'none';
            noteToDelete = null;
        }

        function confirmDelete() {
            if (noteToDelete) {
                deleteNote(noteToDelete);
                hideModal();
            }
        }

        function cancelDelete() {
            hideModal();
        }

        function deleteNote(id) {
            const idx = notes.findIndex(n => n.id === id);
            if (idx === -1) return;
            notes.splice(idx, 1);
            
            if (activeId === id) notes.length ? selectNote(notes[0].id) : createNote();
            else { render($('.search').value); save(); }
        }

        /* ---------- editor ---------- */
        $('#editor').addEventListener('input', () => {
            const note = notes.find(n => n.id === activeId);
            if (!note) return;
            note.text = Array.from($('#editor').querySelectorAll('div')).map(d => d.innerText).join('\n');
            render($('.search').value);
            save();
        });

        /* ---------- search ---------- */
        $('.search').addEventListener('input', () => {
            const searchValue = $('.search').value.trim();
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                render(searchValue);
                
                if (isMobile && searchValue.length > 0 && currentPanel !== 'search') {
                    if (currentPanel === 'notes') {
                        closePanel();
                    }
                    openPanel('search');
                } else if (isMobile && searchValue.length === 0 && currentPanel === 'search') {
                    closePanel();
                }
            }, 200);
        });

        // Clear search handler
        $('.search').addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                $('.search').value = '';
                render('');
                $('#editor').focus();
                if (isMobile && currentPanel === 'search') {
                    closePanel();
                }
            }
        });

        // Focus handler for search
        $('.search').addEventListener('focus', () => {
            if (isMobile && $('.search').value.trim().length > 0 && currentPanel !== 'search') {
                if (currentPanel === 'notes') {
                    closePanel();
                }
                openPanel('search');
            }
        });

        /* ---------- buttons ---------- */
        $('#newNote').onclick = createNote;
        $('#logoBtn').onclick = () => {
            if (isMobile) {
                togglePanel();
            }
        };
        $('#closePanelBtn').onclick = closeAllPanels;
        $('#closeSearchBtn').onclick = closeAllPanels;
        $('#panelOverlay').onclick = closeAllPanels;

        // Update isMobile on window resize
        window.addEventListener('resize', handleResize);

        function handleResize() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            windowHeight = window.innerHeight;
            
            if (wasMobile !== isMobile) {
                if (!isMobile) {
                    closeAllPanels();
                }
                render($('.search').value);
            }
        }

        /* ---------- keyboard ---------- */
        addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); createNote(); }
            if (e.key === 'Escape' && document.activeElement === $('.search')) {
                $('.search').value = '';
                render('');
                $('#editor').focus();
                if (isMobile && currentPanel === 'search') {
                    closePanel();
                }
            }
            if (e.key === 'Escape' && noteToDelete) {
                cancelDelete();
            }
        });

        // Modal button handlers
        $('#modalDelete').onclick = confirmDelete;
        $('#modalCancel').onclick = cancelDelete;

        // Close modal when clicking on overlay
        $('#modalOverlay').onclick = (e) => {
            if (e.target === $('#modalOverlay')) {
                cancelDelete();
            }
        };

        /* ---------- init ---------- */
        function init() {
            if (!notes.length) createNote();
            else {
                const exists = notes.find(n => n.id === activeId);
                selectNote(exists ? activeId : notes[0].id);
            }
            
            windowHeight = window.innerHeight;
            isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                setupSwipe();
            }
            
            render();
        }
        init();
    </script>
</body>

</html>
