<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Notes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .bg-main { background-color: #ffffff; }
      .dark .bg-main { background-color: #1a1a1a; }

      .text-main { color: #000000; }
      .dark .text-main { color: #ffffff; }

      .text-muted { color: rgba(0, 0, 0, 0.4); }
      .dark .text-muted { color: rgba(255, 255, 255, 0.4); }

      .note-item {
        background: transparent;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        transition: background 0.2s ease;
      }
      .dark .note-item {
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .note-item:active {
        background: rgba(0, 0, 0, 0.02);
      }
      .dark .note-item:active {
        background: rgba(255, 255, 255, 0.02);
      }

      .fab {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #000000;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
        transition: transform 0.2s ease;
        z-index: 100;
      }
      .dark .fab {
        background: #ffffff;
        color: #000000;
      }
      .fab:active {
        transform: scale(0.95);
      }

      .editor-overlay {
        position: fixed;
        inset: 0;
        background: #ffffff;
        z-index: 200;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .dark .editor-overlay {
        background: #1a1a1a;
      }
      .editor-overlay.active {
        transform: translateX(0);
      }

      textarea, input {
        border: none;
        outline: none;
        background: transparent;
        resize: none;
        font-family: inherit;
      }

      .custom-checkbox {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid currentColor;
        border-radius: 50%;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
      }
      .custom-checkbox:checked {
        background: #000000;
        border-color: #000000;
      }
      .dark .custom-checkbox:checked {
        background: #ffffff;
        border-color: #ffffff;
      }
      .custom-checkbox:checked::after {
        content: '';
        position: absolute;
        width: 6px;
        height: 3px;
        border-left: 2px solid #ffffff;
        border-bottom: 2px solid #ffffff;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -60%) rotate(-45deg);
      }
      .dark .custom-checkbox:checked::after {
        border-color: #000000;
      }

      .menu-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .menu-btn:active {
        background: rgba(0, 0, 0, 0.05);
      }
      .dark .menu-btn:active {
        background: rgba(255, 255, 255, 0.05);
      }

      ::-webkit-scrollbar { display: none; }
      
      .canvas-container {
        touch-action: none;
      }

      #sketch-canvas {
        background: #fafafa;
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      .dark #sketch-canvas {
        background: #0a0a0a;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .asset-card {
        aspect-ratio: 1;
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(0, 0, 0, 0.06);
      }
      .dark .asset-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .modal-backdrop {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
      }
      .dark .modal-backdrop {
        background: rgba(0, 0, 0, 0.6);
      }
    </style>
</head>
<body class="bg-main text-main transition-colors duration-300">
    <div id="root" class="h-screen w-full flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="px-6 py-4 flex items-center justify-between shrink-0">
        <h1 class="text-3xl font-light tracking-tight">Notes</h1>
        <div class="flex items-center gap-2">
          <button id="search-toggle" class="menu-btn">
            <i data-lucide="search" class="w-5 h-5"></i>
          </button>
          <button id="theme-toggle" class="menu-btn">
            <i data-lucide="moon" id="theme-icon" class="w-5 h-5"></i>
          </button>
        </div>
      </header>

      <!-- Search Bar (Hidden by default) -->
      <div id="search-bar" class="hidden px-6 pb-4">
        <input id="search-input" type="text" placeholder="Search..." class="w-full text-main py-3 px-4 border-b border-black/10 dark:border-white/10">
      </div>

      <!-- Notes List -->
      <main id="note-list" class="flex-1 overflow-y-auto">
        <!-- Notes rendered here -->
      </main>

      <!-- FAB -->
      <button id="add-note" class="fab">
        <i data-lucide="plus" class="w-6 h-6"></i>
      </button>

      <!-- Editor -->
      <div id="editor-overlay" class="editor-overlay">
        <div class="h-full flex flex-col">
          <!-- Editor Header -->
          <div class="px-6 py-4 flex items-center justify-between shrink-0">
            <button id="close-editor" class="menu-btn">
              <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </button>
            <div class="flex items-center gap-2">
              <button id="toggle-pin" class="menu-btn">
                <i data-lucide="pin" class="w-5 h-5"></i>
              </button>
              <button id="editor-menu" class="menu-btn">
                <i data-lucide="more-vertical" class="w-5 h-5"></i>
              </button>
            </div>
          </div>

          <!-- Mode Tabs -->
          <div class="px-6 pb-4 flex gap-6 text-sm shrink-0">
            <button id="mode-text" class="mode-btn opacity-40">Note</button>
            <button id="mode-checklist" class="mode-btn opacity-40">List</button>
            <button id="mode-doodle" class="mode-btn opacity-40">Draw</button>
          </div>

          <!-- Editor Content -->
          <div class="flex-1 overflow-y-auto px-6">
            <input id="note-title" type="text" placeholder="Title" class="w-full text-3xl font-semibold text-main mb-6">
            <div id="content-area" class="pb-32"></div>
            <div id="assets-area" class="hidden pt-8 pb-32">
              <div class="text-xs font-medium text-muted mb-4">ATTACHMENTS</div>
              <div id="assets-grid" class="grid grid-cols-2 gap-4"></div>
            </div>
          </div>

          <!-- Editor Footer -->
          <div class="px-6 py-4 border-t border-black/6 dark:border-white/6 flex items-center justify-between shrink-0 bg-main">
            <div class="flex gap-3">
              <button id="attach-image" class="menu-btn">
                <i data-lucide="image" class="w-5 h-5"></i>
              </button>
              <button id="attach-file" class="menu-btn">
                <i data-lucide="paperclip" class="w-5 h-5"></i>
              </button>
              <button id="toggle-mic" class="menu-btn">
                <i data-lucide="mic" class="w-5 h-5"></i>
              </button>
            </div>
            <div id="note-time" class="text-xs text-muted">Just now</div>
          </div>
        </div>
      </div>

      <!-- Editor Menu Modal -->
      <div id="editor-menu-modal" class="hidden fixed inset-0 z-[300] modal-backdrop flex items-end">
        <div class="w-full bg-main rounded-t-3xl p-6 space-y-1">
          <button id="menu-delete" class="w-full py-4 text-left text-red-500 font-medium">Delete Note</button>
          <button id="menu-cancel" class="w-full py-4 text-left font-medium">Cancel</button>
        </div>
      </div>

      <!-- Delete Confirmation -->
      <div id="delete-dialog" class="hidden fixed inset-0 z-[400] flex items-center justify-center p-6 modal-backdrop">
        <div class="bg-main rounded-3xl p-8 max-w-xs w-full space-y-6">
          <div class="text-center space-y-2">
            <h2 class="text-xl font-semibold">Delete Note?</h2>
            <p class="text-sm text-muted">This cannot be undone.</p>
          </div>
          <div class="space-y-3">
            <button id="confirm-delete" class="w-full py-3 bg-red-500 text-white rounded-full font-medium">Delete</button>
            <button id="cancel-delete" class="w-full py-3 bg-black/5 dark:bg-white/5 rounded-full font-medium">Cancel</button>
          </div>
        </div>
      </div>

      <input type="file" id="file-input" class="hidden">
      <input type="file" id="image-input" accept="image/*" class="hidden">
    </div>

    <script>
      let state = {
        notes: JSON.parse(localStorage.getItem('notes') || '[]'),
        activeId: null,
        searchQuery: '',
        theme: localStorage.getItem('theme') || 'light',
        isRecording: false,
        noteToDelete: null,
        searchVisible: false
      };

      const save = () => localStorage.setItem('notes', JSON.stringify(state.notes));
      const getActiveNote = () => state.notes.find(n => n.id === state.activeId);

      const init = () => {
        applyTheme();
        renderNoteList();
        lucide.createIcons();
      };

      const applyTheme = () => {
        document.documentElement.classList.toggle('dark', state.theme === 'dark');
        localStorage.setItem('theme', state.theme);
        const icon = document.getElementById('theme-icon');
        icon.setAttribute('data-lucide', state.theme === 'dark' ? 'sun' : 'moon');
        lucide.createIcons();
      };

      const renderNoteList = () => {
        const filtered = state.notes
          .filter(n => {
            const q = state.searchQuery.toLowerCase();
            return (n.title || '').toLowerCase().includes(q) || (n.content || '').toLowerCase().includes(q);
          })
          .sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            return b.updatedAt - a.updatedAt;
          });

        const noteList = document.getElementById('note-list');
        
        if (filtered.length === 0) {
          noteList.innerHTML = '<div class="py-20 text-center text-muted text-sm">No notes yet</div>';
          return;
        }

        noteList.innerHTML = filtered.map(note => {
          const preview = note.mode === 'text' ? (note.content || '').substring(0, 100) :
                         note.mode === 'checklist' ? `${(note.items || []).length} items` :
                         'Drawing';
          return `
            <button onclick="openEditor('${note.id}')" class="note-item w-full text-left px-6 py-4 flex items-start gap-4">
              ${note.pinned ? '<i data-lucide="pin" class="w-4 h-4 mt-1 shrink-0 opacity-40"></i>' : '<div class="w-4"></div>'}
              <div class="flex-1 min-w-0">
                <div class="font-medium mb-1">${note.title || 'Untitled'}</div>
                <div class="text-sm text-muted truncate">${preview}</div>
              </div>
              <div class="text-xs text-muted shrink-0 mt-1">${new Date(note.updatedAt).toLocaleDateString([], { month: 'short', day: 'numeric' })}</div>
            </button>
          `;
        }).join('');
        lucide.createIcons();
      };

      const openEditor = (id) => {
        state.activeId = id;
        const note = getActiveNote();
        document.getElementById('editor-overlay').classList.add('active');
        document.getElementById('note-title').value = note.title;
        updateEditorUI();
      };

      const closeEditor = () => {
        state.activeId = null;
        document.getElementById('editor-overlay').classList.remove('active');
        renderNoteList();
      };

      const updateEditorUI = () => {
        const note = getActiveNote();
        if (!note) return;

        document.querySelectorAll('.mode-btn').forEach(btn => {
          const mode = btn.id.split('-')[1];
          btn.classList.toggle('opacity-100', note.mode === mode);
          btn.classList.toggle('opacity-40', note.mode !== mode);
          btn.classList.toggle('font-semibold', note.mode === mode);
        });

        const pinBtn = document.getElementById('toggle-pin');
        pinBtn.style.opacity = note.pinned ? '1' : '0.4';

        document.getElementById('note-time').textContent = new Date(note.updatedAt).toLocaleString([], { 
          hour: '2-digit', 
          minute: '2-digit', 
          month: 'short', 
          day: 'numeric' 
        });

        renderEditorContent();
        renderAssets();
      };

      const renderEditorContent = () => {
        const note = getActiveNote();
        const contentArea = document.getElementById('content-area');

        if (note.mode === 'text') {
          contentArea.innerHTML = `<textarea id="note-body" class="w-full text-main text-base leading-relaxed" placeholder="Start writing..." style="min-height: 400px;">${note.content || ''}</textarea>`;
          document.getElementById('note-body').addEventListener('input', e => {
            note.content = e.target.value;
            note.updatedAt = Date.now();
            save();
          });
        } else if (note.mode === 'checklist') {
          contentArea.innerHTML = `
            <div class="space-y-4">
              <div class="flex gap-3 items-center pb-4 border-b border-black/6 dark:border-white/6">
                <input id="new-item-input" type="text" placeholder="Add item..." class="flex-1 text-main py-2">
                <button onclick="addChecklistItem()" class="w-10 h-10 rounded-full bg-black dark:bg-white flex items-center justify-center shrink-0">
                  <i data-lucide="plus" class="w-5 h-5 text-white dark:text-black"></i>
                </button>
              </div>
              <div id="checklist-items" class="space-y-3"></div>
            </div>
          `;
          document.getElementById('new-item-input').addEventListener('keydown', e => e.key === 'Enter' && addChecklistItem());
          renderChecklistItems();
        } else if (note.mode === 'doodle') {
          contentArea.innerHTML = `
            <div class="space-y-4">
              <div class="flex justify-end">
                <button onclick="clearCanvas()" class="text-xs text-muted">Clear</button>
              </div>
              <div class="canvas-container">
                <canvas id="sketch-canvas" class="w-full rounded-2xl" style="height: 400px;"></canvas>
              </div>
            </div>
          `;
          initCanvas();
        }
        lucide.createIcons();
      };

      const renderChecklistItems = () => {
        const note = getActiveNote();
        const container = document.getElementById('checklist-items');
        if (!container) return;

        container.innerHTML = (note.items || []).map(item => `
          <div class="flex items-center gap-3 group">
            <input type="checkbox" ${item.completed ? 'checked' : ''} onchange="toggleChecklistItem('${item.id}')" class="custom-checkbox shrink-0">
            <span class="flex-1 ${item.completed ? 'line-through opacity-40' : ''}">${item.text}</span>
            <button onclick="removeChecklistItem('${item.id}')" class="opacity-0 group-hover:opacity-40 text-red-500">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
        `).join('');
        lucide.createIcons();
      };

      const renderAssets = () => {
        const note = getActiveNote();
        const assetsArea = document.getElementById('assets-area');
        const assetsGrid = document.getElementById('assets-grid');

        if (!note.attachments?.length) {
          assetsArea.classList.add('hidden');
          return;
        }

        assetsArea.classList.remove('hidden');
        assetsGrid.innerHTML = note.attachments.map(att => `
          <div class="asset-card relative group">
            <button onclick="removeAttachment('${att.id}')" class="absolute top-2 right-2 w-8 h-8 bg-white dark:bg-black rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 z-10">
              <i data-lucide="x" class="w-4 h-4 text-red-500"></i>
            </button>
            ${att.type === 'image' ? `<img src="${att.data}" class="w-full h-full object-cover">` :
              att.type === 'voice' ? `<div class="w-full h-full flex flex-col items-center justify-center p-4 gap-2"><i data-lucide="music" class="w-8 h-8 opacity-40"></i><audio src="${att.data}" controls class="w-full"></audio></div>` :
              `<div class="w-full h-full flex flex-col items-center justify-center p-4 gap-2"><i data-lucide="file-text" class="w-8 h-8 opacity-40"></i><a href="${att.data}" download="${att.name}" class="text-xs">Download</a></div>`}
          </div>
        `).join('');
        lucide.createIcons();
      };

      let canvasCtx = null, drawing = false;
      const initCanvas = () => {
        const canvas = document.getElementById('sketch-canvas');
        if (!canvas) return;

        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        canvasCtx = canvas.getContext('2d');
        canvasCtx.lineCap = 'round';
        canvasCtx.lineWidth = 3;
        canvasCtx.strokeStyle = state.theme === 'dark' ? '#ffffff' : '#000000';

        const note = getActiveNote();
        if (note.doodleData) {
          const img = new Image();
          img.onload = () => canvasCtx.drawImage(img, 0, 0);
          img.src = note.doodleData;
        }

        const getXY = (e) => {
          const rect = canvas.getBoundingClientRect();
          const clientX = e.touches ? e.touches[0].clientX : e.clientX;
          const clientY = e.touches ? e.touches[0].clientY : e.clientY;
          return [clientX - rect.left, clientY - rect.top];
        };

        const start = (e) => {
          e.preventDefault();
          drawing = true;
          canvasCtx.beginPath();
          canvasCtx.moveTo(...getXY(e));
        };

        const draw = (e) => {
          e.preventDefault();
          if (!drawing) return;
          canvasCtx.lineTo(...getXY(e));
          canvasCtx.stroke();
        };

        const stop = () => {
          if (!drawing) return;
          drawing = false;
          canvasCtx.closePath();
          note.doodleData = canvas.toDataURL();
          note.updatedAt = Date.now();
          save();
        };

        canvas.addEventListener('mousedown', start);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stop);
        canvas.addEventListener('mouseout', stop);
        canvas.addEventListener('touchstart', start);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stop);
      };

      window.clearCanvas = () => {
        const canvas = document.getElementById('sketch-canvas');
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        const note = getActiveNote();
        note.doodleData = null;
        save();
      };

      let mediaRecorder = null, audioChunks = [];
      const toggleMic = async () => {
        if (state.isRecording) {
          mediaRecorder.stop();
          state.isRecording = false;
          updateMicUI();
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
              const blob = new Blob(audioChunks, { type: 'audio/webm' });
              const reader = new FileReader();
              reader.onload = e => {
                const note = getActiveNote();
                note.attachments = [...(note.attachments || []), {
                  id: Date.now() + '-v',
                  type: 'voice',
                  name: `Recording_${new Date().getTime()}`,
                  data: e.target.result
                }];
                note.updatedAt = Date.now();
                save();
                renderAssets();
              };
              reader.readAsDataURL(blob);
              stream.getTracks().forEach(t => t.stop());
            };
            mediaRecorder.start();
            state.isRecording = true;
            updateMicUI();
          } catch (err) {
            alert("Microphone access required");
          }
        }
      };

      const updateMicUI = () => {
        const btn = document.getElementById('toggle-mic');
        btn.style.opacity = state.isRecording ? '1' : '0.4';
        const icon = btn.querySelector('i');
        icon.setAttribute('data-lucide', state.isRecording ? 'square' : 'mic');
        lucide.createIcons();
      };

      // Event Listeners
      document.getElementById('add-note').onclick = () => {
        const newNote = {
          id: Date.now().toString(),
          title: '',
          content: '',
          mode: 'text',
          items: [],
          pinned: false,
          updatedAt: Date.now(),
          attachments: []
        };
        state.notes.push(newNote);
        save();
        openEditor(newNote.id);
        setTimeout(() => document.getElementById('note-title').focus(), 300);
      };

      document.getElementById('theme-toggle').onclick = () => {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        applyTheme();
        if (state.activeId) updateEditorUI();
      };

      document.getElementById('search-toggle').onclick = () => {
        state.searchVisible = !state.searchVisible;
        const searchBar = document.getElementById('search-bar');
        searchBar.classList.toggle('hidden', !state.searchVisible);
        if (state.searchVisible) {
          document.getElementById('search-input').focus();
        }
      };

      document.getElementById('search-input').oninput = (e) => {
        state.searchQuery = e.target.value;
        renderNoteList();
      };

      document.getElementById('close-editor').onclick = closeEditor;

      document.getElementById('note-title').oninput = (e) => {
        const note = getActiveNote();
        note.title = e.target.value;
        note.updatedAt = Date.now();
        save();
      };

      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.onclick = () => {
          const note = getActiveNote();
          note.mode = btn.id.split('-')[1];
          note.updatedAt = Date.now();
          save();
          updateEditorUI();
        };
      });

      document.getElementById('toggle-pin').onclick = () => {
        const note = getActiveNote();
        note.pinned = !note.pinned;
        note.updatedAt = Date.now();
        save();
        updateEditorUI();
      };

      document.getElementById('editor-menu').onclick = () => {
        document.getElementById('editor-menu-modal').classList.remove('hidden');
      };

      document.getElementById('menu-delete').onclick = () => {
        document.getElementById('editor-menu-modal').classList.add('hidden');
        document.getElementById('delete-dialog').classList.remove('hidden');
        state.noteToDelete = state.activeId;
      };

      document.getElementById('menu-cancel').onclick = () => {
        document.getElementById('editor-menu-modal').classList.add('hidden');
      };

      document.getElementById('confirm-delete').onclick = () => {
        state.notes = state.notes.filter(n => n.id !== state.noteToDelete);
        save();
        closeEditor();
        document.getElementById('delete-dialog').classList.add('hidden');
      };

      document.getElementById('cancel-delete').onclick = () => {
        document.getElementById('delete-dialog').classList.add('hidden');
      };

      document.getElementById('toggle-mic').onclick = toggleMic;

      document.getElementById('attach-image').onclick = () => {
        document.getElementById('image-input').click();
      };

      document.getElementById('attach-file').onclick = () => {
        document.getElementById('file-input').click();
      };

      const handleFile = (e, type) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const note = getActiveNote();
          note.attachments.push({
            id: Date.now() + '-f',
            type,
            name: file.name,
            data: ev.target.result
          });
          note.updatedAt = Date.now();
          save();
          renderAssets();
          e.target.value = '';
        };
        reader.readAsDataURL(file);
      };

      document.getElementById('image-input').onchange = e => handleFile(e, 'image');
      document.getElementById('file-input').onchange = e => handleFile(e, 'file');

      window.addChecklistItem = () => {
        const input = document.getElementById('new-item-input');
        if (!input?.value.trim()) return;
        const note = getActiveNote();
        note.items.push({
          id: Date.now().toString(),
          text: input.value.trim(),
          completed: false
        });
        note.updatedAt = Date.now();
        save();
        input.value = '';
        renderChecklistItems();
      };

      window.toggleChecklistItem = (id) => {
        const note = getActiveNote();
        const item = note.items.find(i => i.id === id);
        item.completed = !item.completed;
        note.updatedAt = Date.now();
        save();
        renderChecklistItems();
      };

      window.removeChecklistItem = (id) => {
        const note = getActiveNote();
        note.items = note.items.filter(i => i.id !== id);
        note.updatedAt = Date.now();
        save();
        renderChecklistItems();
      };

      window.removeAttachment = (id) => {
        const note = getActiveNote();
        note.attachments = note.attachments.filter(a => a.id !== id);
        note.updatedAt = Date.now();
        save();
        renderAssets();
      };

      init();
    </script>
</body>
</html>
