<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Minimal Notes â€“ Fixed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #ffffff;
            --bg-secondary: #fbfbfc;
            --bg-hover: #FFEE8C;
            --bg-active: #FFEE8C;
            --border: #e5e5e7;
            --text: #1c1c1e;
            --text-muted: #8e8e93;
            --input-bg: #f9f9fa;
            --delete-red: #ff3b30;
            --delete-dark: #ff453a;
            --modal-overlay: rgba(0, 0, 0, 0.4);
        }

        body.dark {
            --bg: #1c1c1e;
            --bg-secondary: #2c2c2e;
            --bg-hover: #3a3a3c;
            --bg-active: #48484a;
            --border: #3a3a3c;
            --text: #f2f2f7;
            --text-muted: #a1a1a6;
            --input-bg: #2c2c2e;
            --delete-red: #ff453a;
            --modal-overlay: rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            /* Prevent body scrolling */
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }

        .app {
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .topbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 10;
            background: var(--bg);
        }

        .logo-btn {
            background: transparent;
            border: none;
            cursor: default;
            /* Make it non-clickable */
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 28px;
            flex-shrink: 0;
        }

        .logo-btn svg {
            width: 35px;
            height: 19px;
        }

        .search {
            flex: 1;
            padding: 6px 8px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            margin-left: 0;
            /* Reset any left margin */
        }

        .btn {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            cursor: pointer;
            flex-shrink: 0;
        }

        .main {
            display: flex;
            flex: 1;
            min-height: 0;
            position: relative;
            overflow: hidden;
        }

        .list {
            width: 28%;
            border-right: 1px solid var(--border);
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .list-header {
            display: none;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            cursor: pointer;
            user-select: none;
            flex-shrink: 0;
            z-index: 5;
        }

        .expand-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            padding: 4px;
            margin-right: 8px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            border-radius: 4px;
        }

        .expand-btn:hover {
            background: var(--bg-hover);
        }

        .expand-btn.rotated {
            transform: rotate(180deg);
        }

        .current-note-title {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text);
        }

        .note-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .note {
            position: relative;
            border-radius: 6px;
            margin-bottom: 2px;
            overflow: hidden;
            background: transparent;
        }

        .note .swipe-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--delete-red);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            color: #fff;
            font-weight: bold;
            z-index: 0;
            /* Remove border-radius from swipe background */
            border-radius: 0;
            /* Make it extend slightly beyond the note bounds to cover corners */
            transform: translateX(100%);
            transition: transform 0.2s ease-out;
        }

        /* When swiping, show the background */
        .note.swiping .swipe-bg {
            transform: translateX(0);
        }

        .note-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 8px 10px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            transition: background .2s, transform .2s;
            transform: translateX(0);
            /* Ensure content clips to its own border-radius */
            overflow: hidden;
        }

        .note.active .note-content {
            background: var(--bg-active);
            font-weight: 500;
        }

        .note:hover .note-content {
            background: var(--bg-hover);
        }

        .note mark {
            background: #ffd600;
            color: inherit;
        }

        body.dark .note mark {
            background: #ffd60a;
            color: #000;
        }

        .delete-btn {
            opacity: 0;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-muted);
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .delete-btn svg {
            display: block;
            stroke: currentColor;
        }

        .note:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            color: var(--text);
        }

        .empty-state {
            text-align: center;
            padding: 24px 12px;
            color: var(--text-muted);
            font-size: 14px;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .editor {
            flex: 1;
            padding: 16px 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #editor {
            flex: 1;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text);
            font-family: inherit;
            min-height: 0;
            cursor: text;
            -webkit-user-select: text;
            user-select: text;
        }

        #editor>div:first-child {
            font-size: 20px;
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 8px;
        }

        #editor:empty:before {
            content: attr(data-placeholder);
            color: var(--text-muted);
        }

        .hint {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 6px;
            flex-shrink: 0;
            padding: 0 20px 16px;
        }

        /* Desktop: show all notes, scroll when needed */
        @media (min-width: 769px) {
            body {
                position: static;
                overflow: auto;
            }
            
            .app {
                height: auto;
                min-height: 100vh;
            }
            
            .list {
                height: auto;
                /* Let content determine height */
                overflow-y: hidden;
                /* Scroll is handled by note-list-container */
            }
            
            .note-list-container {
                overflow-y: auto;
                /* Scroll when content exceeds available space */
            }
        }

        /* Mobile: editor on top, collapsible list below */
        @media (max-width: 768px) {
            body {
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
                touch-action: none;
            }
            
            .app {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                max-width: 100%;
                margin: 0;
                height: 100%;
                overflow: hidden;
            }

            .main {
                flex-direction: column;
                height: calc(100% - 49px);
                /* Subtract topbar height */
                flex: 1;
                min-height: 0;
                overflow: hidden;
            }

            .list {
                width: 100%;
                border-right: none;
                border-top: 1px solid var(--border);
                max-height: 50px;
                /* Only show header when collapsed */
                transition: max-height 0.3s ease;
                flex-shrink: 0;
                position: relative;
                z-index: 5;
            }

            .list.expanded {
                max-height: 50%;
                /* Take up to 50% of remaining space */
                flex: 1;
                min-height: 0;
            }

            .list-header {
                display: flex;
                position: sticky;
                top: 0;
                z-index: 2;
            }

            .note-list-container {
                overflow-y: auto;
                flex: 1;
                min-height: 0;
                -webkit-overflow-scrolling: touch;
            }

            .list:not(.expanded) .note-list-container {
                display: none;
            }

            .editor-container {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                position: relative;
                height: calc(100% - 50px);
                /* Subtract list header height */
                transition: height 0.3s ease;
            }

            .list.expanded + .editor-container {
                height: 50%;
                /* When list is expanded, editor takes 50% height */
                min-height: 0;
            }

            .editor {
                padding: 12px 16px;
                flex: 1;
                overflow-y: auto;
                min-height: 0;
                height: 100%;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 20px;
                /* Extra padding for keyboard */
            }

            .hint {
                padding: 0 16px 12px;
                flex-shrink: 0;
            }

            /* When virtual keyboard is active */
            .keyboard-active .editor {
                padding-top: 8px;
                padding-bottom: 40px;
                /* More padding when keyboard is active */
            }

            .keyboard-active .hint {
                display: none;
            }
            
            /* Adjust for iOS Safari bottom bar */
            @supports (-webkit-touch-callout: none) {
                body {
                    height: -webkit-fill-available;
                }
                
                .app {
                    height: -webkit-fill-available;
                }
                
                .editor {
                    padding-bottom: env(safe-area-inset-bottom, 20px);
                }
            }
        }

        /* Delete Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--modal-overlay);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 24px;
            min-width: 300px;
            max-width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }

        .modal-message {
            font-size: 15px;
            color: var(--text-muted);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--input-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 80px;
        }

        .modal-btn.cancel:hover {
            background: var(--bg-hover);
        }

        .modal-btn.delete {
            background: var(--delete-red);
            color: white;
            border-color: var(--delete-red);
        }

        .modal-btn.delete:hover {
            opacity: 0.9;
        }
        
        /* Cursor tracking styles */
        .cursor-highlight {
            position: absolute;
            background: rgba(255, 238, 140, 0.3);
            border-radius: 2px;
            pointer-events: none;
            z-index: 1;
            transition: top 0.1s ease;
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="topbar">
            <!-- Logo button (inactive) -->
            <button class="logo-btn" id="logoBtn">
                <!-- Light mode logo (black) by default -->
                <svg width="35" height="19" viewBox="0 0 35 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M4.09943 0.997175L8.31818 14.2585H8.48011L12.7074 0.997175H16.7983L10.7813 18.4517H6.02557L7.30157e-07 0.997175H4.09943ZM17.151 18.4517V5.36081H20.7816V18.4517H17.151ZM18.9748 3.67331C18.4351 3.67331 17.972 3.49433 17.5856 3.13638C17.2049 2.77274 17.0146 2.33808 17.0146 1.8324C17.0146 1.3324 17.2049 0.903425 17.5856 0.545471C17.972 0.181834 18.4351 1.57356e-05 18.9748 1.57356e-05C19.5146 1.57356e-05 19.9748 0.181834 20.3555 0.545471C20.7419 0.903425 20.9351 1.3324 20.9351 1.8324C20.9351 2.33808 20.7419 2.77274 20.3555 3.13638C19.9748 3.49433 19.5146 3.67331 18.9748 3.67331ZM25.6407 10.8835V18.4517H22.01V5.36081H25.4703V7.67047H25.6237C25.9134 6.90911 26.3992 6.30683 27.0811 5.86365C27.7629 5.41479 28.5896 5.19036 29.5612 5.19036C30.4703 5.19036 31.2629 5.38922 31.939 5.78695C32.6151 6.18468 33.1407 6.75286 33.5157 7.49149C33.8907 8.22445 34.0782 9.09945 34.0782 10.1165V18.4517H30.4475V10.7642C30.4532 9.96308 30.2487 9.33808 29.8339 8.88922C29.4191 8.43468 28.8481 8.2074 28.1208 8.2074C27.6322 8.2074 27.2004 8.31252 26.8254 8.52274C26.4561 8.73297 26.1663 9.03979 25.9561 9.4432C25.7515 9.84093 25.6464 10.321 25.6407 10.8835Z"
                        fill="black" />
                </svg>
            </button>

            <input class="search" placeholder="Searchâ€¦" />
            <button class="btn" id="toggleTheme">ðŸŒ™</button>
            <button class="btn" id="newNote">ï¼‹</button>
        </div>
        <div class="main">
            <!-- Desktop: list on left, editor on right -->
            <div class="list" id="noteList">
                <div class="list-header" id="listHeader">
                    <button class="expand-btn" id="expandBtn">ðŸ—»</button>
                    <div class="current-note-title" id="currentNoteTitle">Notes</div>
                </div>
                <div class="note-list-container" id="noteListContainer">
                    <!-- Notes will be rendered here -->
                </div>
            </div>
            <div class="editor-container">
                <div class="editor">
                    <div id="editor" contenteditable="true" spellcheck="false" data-placeholder="Start typingâ€¦"></div>
                </div>
                <div class="hint">Everything saves automatically â€¢ Esc: Clear search</div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title">Delete Note</div>
            <div class="modal-message">Are you sure you want to delete this note? This action cannot be undone.</div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modalCancel">Cancel</button>
                <button class="modal-btn delete" id="modalDelete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        /* ---------- helpers ---------- */
        const $ = q => document.querySelector(q);
        const escapeHTML = t => {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        };

        /* ---------- state ---------- */
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let activeId = localStorage.getItem('activeId');
        let theme = localStorage.getItem('theme') || 'light';
        let searchTimeout = null;
        let noteToDelete = null; // For confirmation modal
        let isMobile = window.innerWidth <= 768;
        let keyboardActive = false;
        let windowHeight = window.innerHeight;
        let listCollapsed = true; // Start collapsed on mobile
        let cursorScrollInterval = null;
        let lastCursorPosition = null;
        let cursorHighlight = null;

        /* ---------- create cursor highlight ---------- */
        function createCursorHighlight() {
            if (!cursorHighlight) {
                cursorHighlight = document.createElement('div');
                cursorHighlight.className = 'cursor-highlight';
                document.body.appendChild(cursorHighlight);
            }
            return cursorHighlight;
        }

        /* ---------- update cursor highlight position ---------- */
        function updateCursorHighlight() {
            if (!keyboardActive || !isMobile) return;
            
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            if (rect.height > 0) {
                cursorHighlight.style.display = 'block';
                cursorHighlight.style.left = rect.left + 'px';
                cursorHighlight.style.top = (rect.top + window.scrollY) + 'px';
                cursorHighlight.style.width = rect.width + 'px';
                cursorHighlight.style.height = rect.height + 'px';
                lastCursorPosition = rect.top;
                
                // Scroll to keep cursor visible
                scrollCursorIntoView(rect.top);
            }
        }

        /* ---------- scroll cursor into view ---------- */
        function scrollCursorIntoView(cursorTop) {
            if (!keyboardActive || !isMobile) return;
            
            const editor = $('.editor');
            const editorRect = editor.getBoundingClientRect();
            const editorScrollTop = editor.scrollTop;
            
            // Calculate visible area
            const visibleTop = editorRect.top;
            const visibleBottom = editorRect.bottom;
            const cursorBottom = cursorTop + 30; // Add some buffer
            
            // Check if cursor is near bottom (where keyboard might cover it)
            const viewportHeight = window.innerHeight;
            const keyboardArea = viewportHeight * 0.4; // Assume keyboard takes ~40% of screen
            
            // If cursor is in the keyboard area, scroll up
            if (cursorBottom > (viewportHeight - keyboardArea)) {
                const scrollAmount = cursorBottom - (viewportHeight - keyboardArea) + 20;
                editor.scrollTop += scrollAmount;
            }
            // If cursor is near top, make sure it's visible
            else if (cursorTop < (visibleTop + 50)) {
                const scrollAmount = cursorTop - visibleTop - 50;
                editor.scrollTop += scrollAmount;
            }
        }

        /* ---------- keyboard detection ---------- */
        function checkKeyboard() {
            if (!isMobile) return;
            
            const newHeight = window.innerHeight;
            const heightDiff = windowHeight - newHeight;
            
            // If viewport height decreased significantly, keyboard is likely open
            if (heightDiff > 150 && !keyboardActive) {
                keyboardActive = true;
                document.body.classList.add('keyboard-active');
                
                // Start tracking cursor position
                startCursorTracking();
                
                // Scroll editor to show cursor after a delay
                setTimeout(() => {
                    updateCursorHighlight();
                    const selection = window.getSelection();
                    if (selection.rangeCount) {
                        const range = selection.getRangeAt(0);
                        const rect = range.getBoundingClientRect();
                        if (rect.height > 0) {
                            scrollCursorIntoView(rect.top);
                        }
                    }
                }, 300);
            } 
            // If viewport height increased, keyboard is likely closed
            else if (heightDiff < -50 && keyboardActive) {
                keyboardActive = false;
                document.body.classList.remove('keyboard-active');
                
                // Stop cursor tracking
                stopCursorTracking();
                
                // Hide cursor highlight
                if (cursorHighlight) {
                    cursorHighlight.style.display = 'none';
                }
                
                // Reset scroll position
                setTimeout(() => {
                    const editor = $('.editor');
                    editor.scrollTop = 0;
                }, 100);
            }
            
            windowHeight = newHeight;
        }

        /* ---------- start cursor tracking ---------- */
        function startCursorTracking() {
            if (!isMobile) return;
            
            // Create highlight element
            createCursorHighlight();
            
            // Clear any existing interval
            if (cursorScrollInterval) {
                clearInterval(cursorScrollInterval);
            }
            
            // Track cursor position periodically
            cursorScrollInterval = setInterval(updateCursorHighlight, 100);
            
            // Also track on input events
            $('#editor').addEventListener('input', updateCursorHighlight);
            $('#editor').addEventListener('click', updateCursorHighlight);
            $('#editor').addEventListener('touchstart', updateCursorHighlight);
        }

        /* ---------- stop cursor tracking ---------- */
        function stopCursorTracking() {
            if (cursorScrollInterval) {
                clearInterval(cursorScrollInterval);
                cursorScrollInterval = null;
            }
            
            $('#editor').removeEventListener('input', updateCursorHighlight);
            $('#editor').removeEventListener('click', updateCursorHighlight);
            $('#editor').removeEventListener('touchstart', updateCursorHighlight);
            
            if (cursorHighlight) {
                cursorHighlight.style.display = 'none';
            }
        }

        // Track window resize for keyboard detection
        window.addEventListener('resize', checkKeyboard);

        // Also check on focus/blur of editor
        $('#editor').addEventListener('focus', () => {
            if (isMobile) {
                setTimeout(() => {
                    checkKeyboard();
                }, 300);
                
                // Auto-collapse list when editor is focused
                if (isMobile && !listCollapsed) {
                    setTimeout(() => {
                        collapseList();
                    }, 100);
                }
            }
        });

        $('#editor').addEventListener('blur', () => {
            if (isMobile && keyboardActive) {
                setTimeout(() => {
                    checkKeyboard();
                }, 300);
            }
        });

        // Auto-collapse when clicking on editor content
        $('#editor').addEventListener('click', () => {
            if (isMobile && !listCollapsed) {
                setTimeout(() => {
                    collapseList();
                }, 100);
            }
        });

        // Track cursor movement within editor
        $('#editor').addEventListener('keyup', updateCursorHighlight);
        $('#editor').addEventListener('mouseup', updateCursorHighlight);
        $('#editor').addEventListener('touchend', updateCursorHighlight);

        // Update isMobile on window resize
        window.addEventListener('resize', handleResize);

        function handleResize() {
            const wasMobile = isMobile;
            isMobile = window.innerWidth <= 768;
            windowHeight = window.innerHeight;
            
            // Reset list state when switching between mobile and desktop
            if (wasMobile !== isMobile) {
                const list = $('#noteList');
                const expandBtn = $('#expandBtn');
                
                if (!isMobile) {
                    // On desktop, always show full list
                    list.classList.remove('expanded');
                    expandBtn.classList.remove('rotated');
                    listCollapsed = false;
                    
                    // Stop cursor tracking on desktop
                    stopCursorTracking();
                } else {
                    // On mobile, start with list collapsed
                    list.classList.remove('expanded');
                    expandBtn.classList.add('rotated');
                    listCollapsed = true;
                    
                    // Create cursor highlight for mobile
                    createCursorHighlight();
                }
                
                updateCurrentNoteTitle();
            }
        }

        /* ---------- update logo based on theme ---------- */
        function updateLogo() {
            const logoBtn = $('#logoBtn');
            if (theme === 'dark') {
                logoBtn.innerHTML = `
      <svg width="35" height="19" viewBox="0 0 35 19" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.09943 0.99716L8.31818 14.2585H8.48011L12.7074 0.99716H16.7983L10.7813 18.4517H6.02557L7.30157e-07 0.99716H4.09943ZM17.151 18.4517V5.3608H20.7816V18.4517H17.151ZM18.9748 3.6733C18.4351 3.6733 17.972 3.49432 17.5856 3.13636C17.2049 2.77273 17.0146 2.33807 17.0146 1.83239C17.0146 1.33239 17.2049 0.90341 17.5856 0.545456C17.972 0.181819 18.4351 4.76837e-07 18.9748 4.76837e-07C19.5146 4.76837e-07 19.9748 0.181819 20.3555 0.545456C20.7419 0.90341 20.9351 1.33239 20.9351 1.83239C20.9351 2.33807 20.7419 2.77273 20.3555 3.13636C19.9748 3.49432 19.5146 3.6733 18.9748 3.6733ZM25.6407 10.8835V18.4517H22.01V5.3608H25.4703V7.67046H25.6237C25.9134 6.90909 26.3992 6.30682 27.0811 5.86364C27.7629 5.41477 28.5896 5.19034 29.5612 5.19034C30.4703 5.19034 31.2629 5.38921 31.939 5.78693C32.6151 6.18466 33.1407 6.75284 33.5157 7.49148C33.8907 8.22443 34.0782 9.09943 34.0782 10.1165V18.4517H30.4475V10.7642C30.4532 9.96307 30.2487 9.33807 29.8339 8.88921C29.4191 8.43466 28.8481 8.20739 28.1208 8.20739C27.6322 8.20739 27.2004 8.3125 26.8254 8.52273C26.4561 8.73296 26.1663 9.03977 25.9561 9.44318C25.7515 9.84091 25.6464 10.321 25.6407 10.8835Z" fill="white"/>
      </svg>
    `;
            } else {
                logoBtn.innerHTML = `
      <svg width="35" height="19" viewBox="0 0 35 19" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.09943 0.997175L8.31818 14.2585H8.48011L12.7074 0.997175H16.7983L10.7813 18.4517H6.02557L7.30157e-07 0.997175H4.09943ZM17.151 18.4517V5.36081H20.7816V18.4517H17.151ZM18.9748 3.67331C18.4351 3.67331 17.972 3.49433 17.5856 3.13638C17.2049 2.77274 17.0146 2.33808 17.0146 1.8324C17.0146 1.3324 17.2049 0.903425 17.5856 0.545471C17.972 0.181834 18.4351 1.57356e-05 18.9748 1.57356e-05C19.5146 1.57356e-05 19.9748 0.181834 20.3555 0.545471C20.7419 0.903425 20.9351 1.3324 20.9351 1.8324C20.9351 2.33808 20.7419 2.77274 20.3555 3.13638C19.9748 3.49433 19.5146 3.67331 18.9748 3.67331ZM25.6407 10.8835V18.4517H22.01V5.36081H25.4703V7.67047H25.6237C25.9134 6.90911 26.3992 6.30683 27.0811 5.86365C27.7629 5.41479 28.5896 5.19036 29.5612 5.19036C30.4703 5.19036 31.2629 5.38922 31.939 5.78695C32.6151 6.18468 33.1407 6.75286 33.5157 7.49149C33.8907 8.22445 34.0782 9.09945 34.0782 10.1165V18.4517H30.4475V10.7642C30.4532 9.96308 30.2487 9.33808 29.8339 8.88922C29.4191 8.43468 28.8481 8.2074 28.1208 8.2074C27.6322 8.2074 27.2004 8.31252 26.8254 8.52274C26.4561 8.73297 26.1663 9.03979 25.9561 9.4432C25.7515 9.84093 25.6464 10.321 25.6407 10.8835Z" fill="black"/>
      </svg>
    `;
            }
        }

        /* ---------- update current note title ---------- */
        function updateCurrentNoteTitle() {
            if (!isMobile) return;
            
            const currentNoteTitle = $('#currentNoteTitle');
            if (activeId) {
                const note = notes.find(n => n.id === activeId);
                if (note) {
                    const title = (note.text.split('\n')[0] || 'Untitled').substring(0, 50);
                    currentNoteTitle.textContent = title || 'Empty Note';
                } else {
                    currentNoteTitle.textContent = 'Notes';
                }
            } else {
                currentNoteTitle.textContent = 'Notes';
            }
        }

        /* ---------- collapse list helper ---------- */
        function collapseList() {
            if (!isMobile || listCollapsed) return;
            
            listCollapsed = true;
            const list = $('#noteList');
            const expandBtn = $('#expandBtn');
            
            list.classList.remove('expanded');
            expandBtn.classList.add('rotated');
            
            // Restore editor to full height
            const editorContainer = $('.editor-container');
            editorContainer.style.height = 'calc(100% - 50px)';
        }

        /* ---------- expand list helper ---------- */
        function expandList() {
            if (!isMobile || !listCollapsed) return;
            
            listCollapsed = false;
            const list = $('#noteList');
            const expandBtn = $('#expandBtn');
            
            list.classList.add('expanded');
            expandBtn.classList.remove('rotated');
            
            // Adjust editor height when list is expanded
            const editorContainer = $('.editor-container');
            editorContainer.style.height = '50%';
        }

        /* ---------- toggle list ---------- */
        function toggleList() {
            if (!isMobile) return;
            
            if (listCollapsed) {
                expandList();
            } else {
                collapseList();
            }
        }

        /* ---------- theme ---------- */
        function applyTheme() {
            document.body.classList.toggle('dark', theme === 'dark');
            $('#toggleTheme').textContent = theme === 'dark' ? 'ðŸ˜ƒ' : 'ðŸ‘»';
            localStorage.setItem('theme', theme);
            updateLogo(); // Update logo when theme changes
        }
        $('#toggleTheme').onclick = () => { theme = theme === 'dark' ? 'light' : 'dark'; applyTheme(); };
        applyTheme();

        /* ---------- storage ---------- */
        function save() {
            localStorage.setItem('notes', JSON.stringify(notes));
            localStorage.setItem('activeId', activeId);
        }

        /* ---------- caret ---------- */
        function caretEnd(el) {
            el.focus();
            const r = document.createRange();
            r.selectNodeContents(el);
            r.collapse(false);
            const s = window.getSelection();
            s.removeAllRanges();
            s.addRange(r);
            
            // On mobile, update cursor position after focusing
            if (isMobile) {
                setTimeout(() => {
                    updateCursorHighlight();
                }, 100);
            }
        }

        /* ---------- render ---------- */
        function render(filter = '') {
            const listContainer = $('#noteListContainer');
            listContainer.innerHTML = '';
            const f = filter.toLowerCase();
            const filtered = notes.filter(n => !f || n.text.toLowerCase().includes(f));

            if (!filtered.length) {
                const e = document.createElement('div');
                e.className = 'empty-state';
                e.textContent = f ? 'No notes match your search' : 'No notes yet';
                listContainer.appendChild(e);
                return;
            }

            const toShow = filtered;
            toShow.forEach(n => {
                const wrap = document.createElement('div');
                wrap.className = 'note' + (n.id === activeId ? ' active' : '');
                wrap.dataset.noteId = n.id;

                const bg = document.createElement('div');
                bg.className = 'swipe-bg';
                bg.textContent = 'Delete';
                wrap.appendChild(bg);

                const content = document.createElement('div');
                content.className = 'note-content';
                let preview = (n.text.split('\n')[0] || 'Untitled').substring(0, 100);
                if (f) {
                    const idx = n.text.toLowerCase().indexOf(f);
                    if (idx !== -1) {
                        const start = Math.max(0, idx - 20);
                        const end = Math.min(n.text.length, idx + f.length + 30);
                        let snippet = n.text.substring(start, end);
                        if (start > 0) snippet = 'â€¦' + snippet;
                        if (end < n.text.length) snippet += 'â€¦';
                        preview = escapeHTML(snippet).replace(
                            new RegExp(`(${escapeHTML(filter)})`, 'gi'),
                            '<mark>$1</mark>'
                        );
                    }
                } else preview = escapeHTML(preview);

                const title = document.createElement('span');
                title.innerHTML = preview;
                title.style.cssText =
                    'flex:1;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;';

                const del = document.createElement('button');
                del.className = 'delete-btn';
                del.innerHTML = `
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                `;
                del.setAttribute('aria-label', 'Delete note');
                del.onclick = e => {
                    e.stopPropagation();
                    requestDeleteNote(n.id);
                };

                content.appendChild(title);
                content.appendChild(del);
                wrap.appendChild(content);

                wrap.onclick = () => {
                    selectNote(n.id);
                    // Auto-collapse on mobile after selecting a note
                    if (isMobile && !listCollapsed) {
                        setTimeout(() => {
                            collapseList();
                        }, 100);
                    }
                };
                
                addSwipe(wrap, n.id);
                listContainer.appendChild(wrap);
            });
            
            // Update current note title
            updateCurrentNoteTitle();
        }

        /* ---------- swipe ---------- */
        function addSwipe(el, id) {
            let sx = 0, cx = 0, swiping = false;
            const content = el.querySelector('.note-content');
            const swipeBg = el.querySelector('.swipe-bg');
            const threshold = 0.75; // 75% threshold for deletion

            el.addEventListener('touchstart', e => {
                sx = e.touches[0].clientX;
                cx = sx;
                swiping = true;
                el.classList.add('swiping');
            }, { passive: true });

            el.addEventListener('touchmove', e => {
                if (!swiping) return;
                cx = e.touches[0].clientX;
                const dx = cx - sx;
                if (dx < 0) {
                    content.style.transform = `translateX(${dx}px)`;
                    // Also slide in the background based on swipe distance
                    const bgTransform = Math.min(100, -dx * 100 / el.offsetWidth);
                    swipeBg.style.transform = `translateX(${100 - bgTransform}%)`;
                }
            }, { passive: true });

            el.addEventListener('touchend', () => {
                swiping = false;
                el.classList.remove('swiping');
                const dx = cx - sx;
                const swipePercentage = -dx / el.offsetWidth;
                
                // Check if swipe exceeds 75% threshold
                if (swipePercentage > threshold) {
                    deleteNote(id); // Direct delete on mobile swipe
                } else {
                    // Animate back to original position
                    content.style.transition = 'transform 0.3s ease-out';
                    swipeBg.style.transition = 'transform 0.3s ease-out';
                    content.style.transform = 'translateX(0)';
                    swipeBg.style.transform = 'translateX(100%)';
                    
                    // Remove transition after animation completes
                    setTimeout(() => {
                        content.style.transition = '';
                        swipeBg.style.transition = '';
                    }, 300);
                    
                    // Only select the note if it wasn't a significant swipe
                    if (swipePercentage < 0.3) {
                        selectNote(id);
                        // Auto-collapse on mobile after selecting a note
                        if (isMobile && !listCollapsed) {
                            setTimeout(() => {
                                collapseList();
                            }, 100);
                        }
                    }
                }
            });

            el.addEventListener('touchcancel', () => {
                swiping = false;
                el.classList.remove('swiping');
                content.style.transition = 'transform 0.3s ease-out';
                swipeBg.style.transition = 'transform 0.3s ease-out';
                content.style.transform = 'translateX(0)';
                swipeBg.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    content.style.transition = '';
                    swipeBg.style.transition = '';
                }, 300);
            });
        }

        /* ---------- crud ---------- */
        function selectNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return createNote();
            activeId = id;
            $('#editor').innerHTML = note.text.split('\n').map(l => `<div>${escapeHTML(l) || '<br>'}</div>`).join('');
            render($('.search').value);
            save();
            setTimeout(() => {
                caretEnd($('#editor'));
                // Update cursor position after selection
                if (isMobile) {
                    setTimeout(updateCursorHighlight, 200);
                }
            }, 0);
            
            // Update title after selection
            updateCurrentNoteTitle();
        }

        function createNote() {
            const note = { id: Date.now().toString(), text: '' };
            notes.unshift(note);
            activeId = note.id;
            $('#editor').innerHTML = '<div><br></div>';
            render($('.search').value);
            save();
            setTimeout(() => {
                caretEnd($('#editor'));
                // Update cursor position after creation
                if (isMobile) {
                    setTimeout(updateCursorHighlight, 200);
                }
            }, 0);
            
            // Update title after creation
            updateCurrentNoteTitle();
            
            // Auto-collapse on mobile when creating new note
            if (isMobile && !listCollapsed) {
                setTimeout(() => {
                    collapseList();
                }, 100);
            }
        }

        /* ---------- Delete with confirmation (desktop) ---------- */
        function requestDeleteNote(id) {
            // Check if we're on desktop (screen width > 768px)
            if (window.innerWidth > 768) {
                noteToDelete = id;
                showModal();
            } else {
                // Mobile: delete directly
                deleteNote(id);
            }
        }

        function showModal() {
            const modalOverlay = $('#modalOverlay');
            modalOverlay.style.display = 'flex';
        }

        function hideModal() {
            const modalOverlay = $('#modalOverlay');
            modalOverlay.style.display = 'none';
            noteToDelete = null;
        }

        function confirmDelete() {
            if (noteToDelete) {
                deleteNote(noteToDelete);
                hideModal();
            }
        }

        function cancelDelete() {
            hideModal();
        }

        function deleteNote(id) {
            const idx = notes.findIndex(n => n.id === id);
            if (idx === -1) return;
            notes.splice(idx, 1);
            
            if (activeId === id) notes.length ? selectNote(notes[0].id) : createNote();
            else { render($('.search').value); save(); }
            
            // Update title after deletion
            updateCurrentNoteTitle();
        }

        // Modal button handlers
        $('#modalDelete').onclick = confirmDelete;
        $('#modalCancel').onclick = cancelDelete;

        // Close modal when clicking on overlay
        $('#modalOverlay').onclick = (e) => {
            if (e.target === $('#modalOverlay')) {
                cancelDelete();
            }
        };

        /* ---------- editor ---------- */
        $('#editor').addEventListener('input', () => {
            const note = notes.find(n => n.id === activeId);
            if (!note) return;
            note.text = Array.from($('#editor').querySelectorAll('div')).map(d => d.innerText).join('\n');
            render($('.search').value);
            save();
            updateCurrentNoteTitle(); // Update title when note content changes
            
            // Update cursor position on input
            if (isMobile && keyboardActive) {
                setTimeout(updateCursorHighlight, 50);
            }
        });

        /* ---------- search ---------- */
        $('.search').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => render($('.search').value), 200);
        });

        /* ---------- buttons ---------- */
        $('#newNote').onclick = createNote;
        $('#expandBtn').onclick = toggleList;
        $('#listHeader').onclick = toggleList;

        // Make logo button inactive (non-clickable)
        $('#logoBtn').onclick = (e) => {
            e.preventDefault();
            return false;
        };

        /* ---------- keyboard ---------- */
        addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); createNote(); }
            if (e.key === 'Escape' && document.activeElement === $('.search')) {
                $('.search').value = '';
                render('');
                $('#editor').focus();
            }
            // Escape also closes modal
            if (e.key === 'Escape' && noteToDelete) {
                cancelDelete();
            }
        });

        /* ---------- init ---------- */
        function init() {
            if (!notes.length) createNote();
            else {
                const exists = notes.find(n => n.id === activeId);
                selectNote(exists ? activeId : notes[0].id);
            }
            
            // Initial check
            windowHeight = window.innerHeight;
            isMobile = window.innerWidth <= 768;
            
            // Set initial mobile state
            if (isMobile) {
                const list = $('#noteList');
                const expandBtn = $('#expandBtn');
                list.classList.remove('expanded');
                expandBtn.classList.add('rotated');
                listCollapsed = true;
                updateCurrentNoteTitle();
                
                // Create cursor highlight for mobile
                createCursorHighlight();
            }
        }
        init();
    </script>
</body>

</html>
